{% style %}
.cart-container-{{ section.id }} {
  height: 100vh;
  width: 100vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  -ms-overflow-style:none;
  scrollbar-width:none;
  @media screen and (min-width: 320px) and (max-width: 767px) and (orientation: portrait) {
    width:96vw;
  }
}

.cart-container-{{ section.id }} td {
  background-color: {{settings.color-scheme-button-bg}};
  color:{{settings.color-scheme-button-text}};
  box-sizing: border-box;
  padding:1em;
  width:20vw;
  text-align: center;
  @media screen and (min-width: 320px) and (max-width: 767px) and (orientation: portrait) {
    width:24vw;
  }
}

.cart-container-{{ section.id }} .subtotal {
  text-align: center;
  color: {{settings.color-scheme-text}};
}

.cart-container-{{ section.id }} button {
  background-color: {{settings.color-scheme-button-bg}};
  border: none;
  color: {{settings.color-scheme-button-text}};
  font-family: var(--font-body-family);
  font-weight:500;
  padding: 1em;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 100%;
  cursor: pointer;
  letter-spacing: var(--font-body-spacing);
}
.cart-container-{{ section.id }} button:hover {
  background-color:white;
  color:{{settings.color-scheme-text}};
}
.remove-item-button {
  cursor:pointer;
  z-index:2;
}
.remove-item-button:hover {
  background-color:white;
  color:{{settings.color-scheme-text}};
}

.quantity-increment,
.quantity-decrement {
  cursor: pointer;
  user-select: none;
  background-color: none;
  color: {{settings.color-scheme-button-text}};
  box-sizing:border-box;
  padding:1em;
}

.quantity-cell {
  white-space: nowrap;
}

.shipping-calculator {
  width: 100%;
  max-width: 400px;
  margin: 2em auto;
  text-align: center;
  position:fixed;
  bottom:0;
}

#shipping-calculator-form {
  margin-top:1em;
}

.shipping-calculator__input {
  margin-bottom: 1em;
}

.shipping-calculator label {
  display: block;
  margin-bottom: 0.5em;
  color: {{settings.color-scheme-text}};
  font-family: var(--font-body-family);
  font-weight: 500;
  font-size: 100%;
  letter-spacing: var(--font-body-spacing);
}

.shipping-calculator select,
.shipping-calculator input[type="text"] {
  width: 100%;
  padding: 0.75em 1em;
  box-sizing: border-box;
  font-family: var(--font-body-family);
  font-weight: 500;
  font-size: 100%;
  letter-spacing: var(--font-body-spacing);
  border: 1px solid {{ settings.color-scheme-text }};
  background-color: transparent;
  color: {{ settings.color-scheme-text }};
}

.shipping-calculator #calculate-shipping {
  width: 100%;
  margin-top: 1em;
}

.shipping-rates,
.errors {
  margin-top: 1em;
  padding: 1em;
  border: 1px solid #ccc;
}

.shipping-rates h4,
.errors h4 {
  margin-top: 0;
}

.shipping-rates ul,
.errors ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#shipping-rates-container {
  margin-top: 1em;
}

#shipping-rates-list {
  list-style: none;
  list-style-type: none;
  margin: 0;
  padding: 0;
  text-align: center;
}

.shipping-rates li {
  font-family: var(--font-body-family);
  font-weight: 500;
  font-size: 100%;
  letter-spacing: var(--font-body-spacing);
  color: {{ settings.color-scheme-text }};
  padding: 0.5em 0;
}

.errors li {
  color: red;
}
{% endstyle %}

<div class="cart-container-{{ section.id }}">

{% if cart.item_count > 0 %}
  <form action="/cart" method="post" novalidate>
    <table>
      <thead>
        <th>ITEM</th>
        <th>QTY</th>
        <th>TOTAL</th>
        <th></th>
      </thead>
      <tbody>
        {% for item in cart.items %}
          <tr>
            <td>
              <a href="{{ item.variant.url }}">
                {{ item.variant.product.title }}
                {% if item.variant.title != "Default Title" %}
                  <br>({{ item.variant.title }})
                {% endif %}
              </a>
            </td>
            <td>
              <span class="quantity-cell">
                <span class="quantity-decrement">-</span>
                <span class="quantity-display" data-line-item-id="{{ item.key }}">{{ item.quantity }}</span>
                <span class="quantity-increment">+</span>
              </span>
            </td>
            <td>
              {% if item.original_line_price != item.line_price %}{{ item.original_line_price | money }}{% endif %}
                {{ item.line_price | money }}
              {% for discount in item.discounts %}{{ discount.title }}{% endfor %}
            </td>
            <td class="cart-remove remove-item-button" data-line-item-id="{{ item.key }}">
              <a>Remove</a>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
    <div class="subtotal">
      <p>Sub Total : {{ cart.total_price | money_without_currency }} AU + Shipping</p>
      <button type="submit" name="checkout">CHECKOUT</button>
    </div>
  </form>
  
  <div class="shipping-calculator">
    SHIPPING ESTIMATE
    <div id="shipping-calculator-form">
      <div class="shipping-calculator__input">
        <label for="address_country">COUNTRY</label>
        <select id="address_country" name="address[country]" data-default="{{ shop.country }}">{{ all_country_option_tags }}</select>
      </div>

      <div id="address_state_container" class="shipping-calculator__input" style="display:none;">
        <label for="address_state" id="address_state_label">STATE</label>
        <select id="address_state" name="address[province]"></select>
      </div>

      <div id="address_zip_container" class="shipping-calculator__input" style="display:none;">
        <label for="address_zip">POSTAL/ZIP</label>
        <input type="text" id="address_zip" name="address[zip]">
      </div>

      <button type="button" id="calculate-shipping" style="display:none;">CALCULATE SHIPPING</button>

      <div id="shipping-rates-container" style="display:none;">
        <ul id="shipping-rates-list"></ul>
      </div>

      <div id="shipping-errors-container" class="errors" style="display:none;">
        <h4>ERRORS</h4>
        <div id="shipping-errors"></div>
      </div>
    </div>
  </div>

{% else %}

  <div class="cart-empty">
    CART IS EMPTY
  </div>
  
{% endif %}

</div>

<script>

function updateCartTotal(newTotal) {
  const subtotalElement = document.querySelector('.subtotal p');
  if (subtotalElement) {
    const formatter = new Intl.NumberFormat('en-AU', { 
      minimumFractionDigits: 2,
      maximumFractionDigits: 2 
    });
    subtotalElement.textContent = `Sub Total : ${formatter.format(newTotal / 100)} AU + Shipping`;
  }
}

function removeItemFromCart(lineItemId) {
  const removeButton = document.querySelector(`.remove-item-button[data-line-item-id="${lineItemId}"]`);
  const row = removeButton ? removeButton.closest('tr') : null;
  const quantityElement = document.querySelector(`.quantity-display[data-line-item-id="${lineItemId}"]`);
  
  if (!row || !quantityElement) return;
  
  const originalQuantity = parseInt(quantityElement.textContent);
  const originalButtonText = removeButton.innerHTML;
  
  const priceCell = row.querySelector('td:nth-child(3)');
  let itemLinePrice = 0;
  if (priceCell) {
    const priceText = priceCell.textContent.trim();
    const priceMatch = priceText.match(/[\d,]+\.?\d*/g);
    if (priceMatch && priceMatch.length > 0) {
      const lastPrice = priceMatch[priceMatch.length - 1];
      const currentPrice = parseFloat(lastPrice.replace(/,/g, ''));
      if (!isNaN(currentPrice) && currentPrice > 0) {
        itemLinePrice = currentPrice * 100; // Convert to cents
      }
    }
  }
  
  removeButton.innerHTML = "Removing...";
  const currentTotal = getCurrentCartTotal();
  const newTotal = currentTotal - itemLinePrice;
  updateCartTotal(newTotal);
  
  // Update header cart
  const currentCartCount = parseInt(document.getElementById('cart-count')?.textContent || '0');
  const newCartCount = Math.max(0, currentCartCount - originalQuantity);
  if (window.updateCartIndicator) {
    window.updateCartIndicator(newCartCount, newTotal);
  }
  
  // Make the actual API call in background
  fetch('/cart/update.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      updates: {
        [lineItemId]: 0
      }
    })
  })
  .then(response => response.json())
  .then(cart => {
    console.log("Item removed:", cart);
    row.remove();
    updateCartTotal(cart.total_price);
    if (cart.item_count === 0) {
      window.location.reload();
    }
  })
  .catch(error => {
    console.error("Error removing item:", error);
    removeButton.innerHTML = originalButtonText;
    window.location.reload();
  });
}

function incrementItem(lineItemId) {
  const currentQuantity = parseInt(document.querySelector(`.quantity-display[data-line-item-id="${lineItemId}"]`).textContent);
  updateCart(lineItemId, currentQuantity + 1);
}

function decrementItem(lineItemId) {
  const button = document.querySelector(`.quantity-decrement[data-line-item-id="${lineItemId}"]`);
  if (button && button.classList.contains('disabled')) {
    return;
  }

  const currentQuantity = parseInt(document.querySelector(`.quantity-display[data-line-item-id="${lineItemId}"]`).textContent);
  if (currentQuantity > 1) {
    updateCart(lineItemId, currentQuantity - 1);
  } else {
    removeItemFromCart(lineItemId);
  }
}

function updateCart(lineItemId, newQuantity) {
  const quantityElement = document.querySelector(`.quantity-display[data-line-item-id="${lineItemId}"]`);
  if (!quantityElement) return;
  
  // Store original quantity for potential revert
  const originalQuantity = parseInt(quantityElement.textContent);
  const row = quantityElement.closest('tr');
  const priceCell = row.querySelector('td:nth-child(3)');
  
  // Calculate price change from existing data
  const currentTotal = getCurrentCartTotal();
  let pricePerUnit = 0;
  
  // Extract current line price from the DOM more reliably
  if (priceCell) {
    const priceText = priceCell.textContent.trim();
    // Handle multiple currency formats: $12.34, AU$12.34, 12.34, etc.
    const priceMatch = priceText.match(/[\d,]+\.?\d*/g);
    if (priceMatch && priceMatch.length > 0) {
      // Take the last price match (in case there are multiple prices like original + discounted)
      const lastPrice = priceMatch[priceMatch.length - 1];
      const currentLinePrice = parseFloat(lastPrice.replace(/,/g, ''));
      if (!isNaN(currentLinePrice) && currentLinePrice > 0) {
        pricePerUnit = currentLinePrice / originalQuantity;
      }
    }
  }
  
  // Optimistic updates - all happen instantly
  quantityElement.textContent = newQuantity;
  
  // Update line price instantly
  if (priceCell && pricePerUnit > 0) {
    const newLinePrice = pricePerUnit * newQuantity;
    const formatter = new Intl.NumberFormat('en-AU', { 
      style: 'currency', 
      currency: 'AUD' 
    });
    
    // Keep existing discount text if any
    const existingText = priceCell.innerHTML;
    const discountMatch = existingText.match(/\)([^$]*$)/);
    const discountText = discountMatch ? discountMatch[1] : '';
    
    priceCell.innerHTML = formatter.format(newLinePrice) + discountText;
  }
  
  // Update total instantly
  if (pricePerUnit > 0) {
    const quantityDiff = newQuantity - originalQuantity;
    const newTotal = currentTotal + (quantityDiff * pricePerUnit * 100); // Convert to cents
    updateCartTotal(newTotal);
    
    // Update header cart
    const currentCartCount = parseInt(document.getElementById('cart-count')?.textContent || '0');
    const newCartCount = currentCartCount + quantityDiff;
    if (window.updateCartIndicator) {
      window.updateCartIndicator(newCartCount, newTotal);
    }
  }
  
  // Make the actual API call in background
  fetch('/cart/update.js', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      updates: {
        [lineItemId]: newQuantity
      }
    })
  })
  .then(response => response.json())
  .then(cart => {
    console.log("Cart updated:", cart);
    // Update with accurate server values
    const updatedItem = cart.items.find(item => item.key === lineItemId);
    if (updatedItem && priceCell) {
      const formatter = new Intl.NumberFormat('en-AU', { 
        style: 'currency', 
        currency: 'AUD' 
      });
      const priceText = formatter.format(updatedItem.line_price / 100);
      const discountHTML = Array.from(updatedItem.discounts || []).map(d => d.title).join('');
      priceCell.innerHTML = updatedItem.original_line_price !== updatedItem.line_price 
        ? `${formatter.format(updatedItem.original_line_price / 100)}${priceText}${discountHTML}`
        : `${priceText}${discountHTML}`;
    }
    // Update with accurate total
    updateCartTotal(cart.total_price);
  })
  .catch(error => {
    console.error("Error updating cart:", error);
    // Revert optimistic changes
    quantityElement.textContent = originalQuantity;
    // Reload to get accurate state
    window.location.reload();
  });
}

function getCurrentCartTotal() {
  const subtotalElement = document.querySelector('.subtotal p');
  if (!subtotalElement) return 0;
  
  const totalText = subtotalElement.textContent;
  // More flexible parsing for different formats
  const totalMatch = totalText.match(/([\d,]+\.?\d*)\s*AU/);
  if (totalMatch) {
    const totalValue = parseFloat(totalMatch[1].replace(/,/g, ''));
    if (!isNaN(totalValue) && totalValue >= 0) {
      return totalValue * 100; // Convert to cents
    }
  }
  return 0;
}

document.addEventListener('DOMContentLoaded', function() {
  const removeButtons = document.querySelectorAll('.remove-item-button');
  removeButtons.forEach(function(button) {
    button.addEventListener('click', function(event) {
      const lineItemId = event.currentTarget.getAttribute('data-line-item-id');
      removeItemFromCart(lineItemId);
      button.innerHTML = "Removing ...";
    });
  });

  const incrementButtons = document.querySelectorAll('.quantity-increment');
  incrementButtons.forEach(function(button) {
    button.addEventListener('click', function(event) {
      const lineItemId = event.currentTarget.closest('tr').querySelector('.remove-item-button').getAttribute('data-line-item-id');
      incrementItem(lineItemId);
    });
  });

  const decrementButtons = document.querySelectorAll('.quantity-decrement');
  decrementButtons.forEach(function(button) {
    button.addEventListener('click', function(event) {
      const lineItemId = event.currentTarget.closest('tr').querySelector('.remove-item-button').getAttribute('data-line-item-id');
      decrementItem(lineItemId);
    });
  });
});
</script>

<script src="{{ 'shipping-calculator.js' | asset_url }}" defer="defer"></script>